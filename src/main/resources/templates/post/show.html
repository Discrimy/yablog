<!doctype html>
<html lang="en" th:replace="base :: base(~{::#content}, ~{::script})" xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Yablog</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">

    <!-- Bootstrap CSS -->
    <link href="../../static/css/bootstrap.min.css" rel="stylesheet" th:href="@{~/static/css/bootstrap.min.css}">
    <link href="../../static/css/style.css" rel="stylesheet" th:href="@{~/static/css/style.css}">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>

<body>

<div id="content">
    <div class="container">
        <div class="card">
            <div class="card-body bg-primary text-light">
                <div class="card-title d-flex justify-content-start align-items-center">
                    <div class="post-vote-btn mr-3 d-flex flex-column">
                        <div class="post-vote-btn post-upvote text-light" id="post-upvote-btn"
                             onclick="onUpvote(-1)" sec:authorize="isAuthenticated()"
                             th:classappend="${isPostUpvoted} ? 'post-vote-done'"
                             th:onclick="'onUpvote(' + ${post.id} + ')'">
                            <i class="fa fa-angle-up"></i>
                        </div>
                        <div id="post-vote-score" th:text="${post.upvotes.size() - post.downvotes.size()}">
                            0
                        </div>
                        <div class="post-vote-btn post-downvote text-light" id="post-downvote-btn"
                             onclick="onDownvote(-1)" sec:authorize="isAuthenticated()"
                             th:classappend="${isPostDownvoted} ? 'post-vote-done'"
                             th:onclick="'onDownvote(' + ${post.id} + ')'">
                            <i class="fa fa-angle-down"></i>
                        </div>
                    </div>
                    <h5 class="mb-0" th:text="${post.title}">Lorem ipsum, dolor sit amet consectetur adipisicing
                        elit.
                        Provident, voluptate? </h5>
                    <div class="post-controls ml-auto">
                        <a class="card-link btn btn-sm btn-secondary d-block mb-1" href="#"
                           th:href="@{'~/post/' + ${post.id} + '/edit'}"
                           th:if="${@accessEvaluator.hasAccessToPost(#request.userPrincipal, post)}">Edit</a>
                        <form action="#" class="d-inline" method="POST"
                              th:action="@{'~/post/' + ${post.id} + '/delete'}"
                              th:if="${@accessEvaluator.hasAccessToPost(#request.userPrincipal, post)}">
                            <button class="btn btn-sm btn-secondary" type="submit">Delete</button>
                        </form>
                    </div>
                </div>
                <h6 class="card-subtitle mb-2">
                    <a class="text-muted" href="#" th:href="@{'~/user/' + ${post.author.id} + '/show'}"
                       th:text="${post.author.username}">USERNAME</a>
                </h6>
                <p class="card-text" th:text="${post.text}">Lorem ipsum dolor sit amet consectetur adipisicing elit.
                    Consequuntur eaque, pariatur recusandae laudantium odio provident officia quos sunt sapiente
                    impedit! Voluptates quod quo ratione doloremque, voluptas provident autem temporibus dignissimos
                    recusandae ut error, laboriosam labore cum dicta iusto expedita? Eius dolor, nostrum harum
                    voluptatum in quisquam molestias quasi provident veniam voluptatem facere totam debitis?
                    Quisquam rem culpa, ducimus, cupiditate voluptatum repellendus inventore deserunt dolorum
                    laudantium fugiat nobis minima sint doloremque rerum corrupti earum, labore exercitationem! Unde
                    asperiores minus tempore sequi delectus veniam. Perspiciatis laborum a sit corrupti quas cumque
                    laboriosam expedita? Excepturi eos recusandae quisquam temporibus deleniti voluptatum, dolores
                    illo!</p>
                <div id="comments-section">
                    <div class="card mb-2 bg-primary text-light border-secondary"
                         th:each="comment : ${post.comments}">
                        <div class="card-body">
                            <h6 class="card-subtitle">
                                <a class="text-muted" href="#"
                                   th:href="@{'~/user/' + ${comment.author.id} + '/show'}"
                                   th:text="${comment.author.username}">USERNAME</a>
                            </h6>
                            <p class="card-text" th:text="${comment.text}">Lorem ipsum dolor sit amet consectetur
                                adipisicing elit. Ipsum voluptatum ipsa nobis nihil! Facilis enim dolore sunt
                                cumque, ipsam fugiat.</p>
                        </div>
                    </div>
                    <div class="card bg-primary mb-2 border-secondary" sec:authorize="isAuthenticated()">
                        <div class="card-body">
                            <h6 class="card-subtitle">
                                <a class="text-muted" href="#"
                                   th:href="@{'~/user/' + ${#authentication.getPrincipal().getUser().getId()} + '/show'}"
                                   th:text="${#authentication.getPrincipal().getUsername()}">USERNAME</a>
                            </h6>

                            <form action="#" method="POST" th:action="@{'~/post/' + ${post.id} + '/addcomment'}">
                                <div class="input-group my-2">
                                    <textarea class="form-control text-black" name="text"
                                              placeholder="Comment"></textarea>
                                </div>
                                <button class="btn btn-primary" type="submit">Submit</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const upvoteBtn = document.querySelector('#post-upvote-btn');
    const downvoteBtn = document.querySelector('#post-downvote-btn');
    const voteScore = document.querySelector('#post-vote-score');

    function onUpvote(postId) {
        fetch(`/post/${postId}/upvote`, {
            method: 'POST',
            credentials: 'same-origin',
        })
        .then(response => {
            console.log(response);
            return response;
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);
            return data;
        })
        .then(data => {
            if (data.status === 'OK') {
                upvoteBtn.classList.add('post-vote-done');
                voteScore.textContent = parseInt(voteScore.textContent) + 1
            }
        });
    }

    function onDownvote(postId) {
        fetch(`/post/${postId}/downvote`, {
            method: 'POST',
            credentials: 'same-origin',
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);
            return data;
        })
        .then(data => {
            if (data.status === 'OK') {
                downvoteBtn.classList.add('post-vote-done');
                voteScore.textContent = parseInt(voteScore.textContent) - 1
            }
        });
    }

</script>
</body>

</html>